<!DOCTYPE html>
<html>
<head>
	<title>
		Chat
	</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<link rel="stylesheet" type="text/css" href="./css/head.css">
	<link rel="stylesheet" type="text/css" href="./css/friends.css">
	<link rel="stylesheet" type="text/css" href="./css/server.css">
	<link rel="stylesheet" type="text/css" href="./css/dialogs-head.css">
	<link rel="stylesheet" type="text/css" href="./css/bottom.css">
	<link rel="stylesheet" type="text/css" href="./css/message-container.css">
	<link rel="stylesheet" type="text/css" href="./css/modal-container.css">
	<link rel="stylesheet" type="text/css" href="./css/login-form.css">
</head>
<body>
	<div id="modal-container">
		<div id="modal-frame">
			<div id="carbon">
				<div id="c12">12,011</div>
				<div id="c6">6</div>
				<div id="c2-4">2 -4</div>
				<div id="c">C</div>
				<div id="ul">-4<br>-3<br>-2<br>-1<br>+1<br>+2<br>+3<br>+4</div>
			</div>
			<div id="hat">hat</div>
			<div id="form">

			</div>
		</div>
	</div>

	<div id="message-container"></div>
	<div id="head">
		<div id="icon"></div>

		<div id="settings-button">Settings</div>

	</div>
	<div id="friends"></div>
	<div id="server">соединение хорошее</div>
	<div id="dialogs-head"></div>
	<div id="delete-messages">Удалить выбранные(будет появляться при выделении</div>
	<div id="bottom">
		<div id="img"></div>
		<textarea id="textarea" placeholder="Enter your message"></textarea>
		<div id="send-message-button">Send</div>
	</div>

<script type="text/javascript" src="jquery-2.1.3.min.js"></script>
<script type="text/javascript" src="./script/variables.js"></script>
<script type="text/javascript" src="./script/LoginForm.js"></script>
<script type="text/javascript">

	function showModal(formToShow) {
		modalIsShown = true;
		form.appendChild(formToShow);
		modalSkeletone.style.display = "block";
	}

	function hideModal () {
		modalIsShown = false;
		while(form.firstChild)
			form.removeChild(form.firstChild);
		modalSkeletone.style.display = "none";
	}

	function enter () {
		hideModal();
		return false;
	}

	function register() {

	}

	function sendMessage() {
		var message = textarea.value;
		if(!message)
			return;
		//messageID?
		//server?
		drawMessage(message, true);
		textarea.value = '';
	}

	function makeTextFitElement(text, element) {
		// if(!element)
		// 	element = document.body;
		// if(widthOfTextInElement(text, element) < 551)
			return addLineDividers(text);
	}

	function addLineDividers(text) {
		return text.replace( /^\s+|\s+$/g, '' ).replace(/\r?\n+/g, '<br>');
	}

	function widthOfTextInElement(text, element) {
		if(!element)
			element = document.body;
		var span = document.createElement("span");
		span.style.display = "none";
		span.innerHTML = text;
		element.appendChild(span);
		var width = $(span).width();
		element.removeChild(span);
		return width;
	}

	function drawMessage(textMessage, my) {
		var message = document.createElement("div");
		message.className = my ? "my-message" : "friend-message";

		var textDiv = document.createElement("div");

		var currentTime = new Date;
		var sendingTime = currentTime.toLocaleTimeString() + "<br>" + currentTime.toLocaleDateString();

		var time = document.createElement("time");
		time.innerHTML = sendingTime;

		message.appendChild(textDiv);
		message.appendChild(time);

		messageContainer.appendChild(message);
		textDiv.innerHTML = makeTextFitElement(textMessage, textDiv);		
		message.scrollIntoView();
	}

	function Settings() {
/*<div id="settings">
					<form>
						<span>Username</span>
						<input type="text">
					</form>
				</div>
*/

		var span = document.createElement("span");
		span.innerText = "Username:";

		var input = document.createElement("input");
		input.type = "text";

		var form = document.createElement("form");
		form.appendChild(span);
		form.appendChild(input);

		var div = document.createElement("div");
		div.appendChild(form);
		div.id = "settings";

		return div;
}

	function showSettings () {
		showModal(new Settings());
	}

	document.getElementById("settings-button").onclick = showSettings;
	document.getElementById("send-message-button").onclick = sendMessage;
	document.body.onkeypress = function(event) {
		if(modalIsShown) return;

		if(event.keyCode == 13) {
			if(sendOnEnter)
				sendMessage();
			else 
			{
				textarea.value = textarea.value.splice(0,textarea.selectionStart-1) + "\n" + textarea.value.splice(textarea.selectionStart);
			}
			return false;
		}
		else if(event.keyCode == 10) {
			if(sendOnEnter)
			{
				textarea.value = textarea.value.splice(0,textarea.selectionStart-1) + "\n" + textarea.value.splice(textarea.selectionStart);
			}
			else sendMessage();
			return false;
		}

		if(event.keyCode < 32) return;
		textarea.focus();
	};
	messageContainer.onmousedown = function (event) {
		function getMessage(target) {
			return target.classList.contains("my-message") ? target : null;
		}

		var message = getMessage(event.target);
		if(!message) return;

		message.classList.toggle('selected-message');
		return false;
	};

//---------------------------------------------------------

	showModal(new LoginForm());
	// modalSkeletone.style.display = "inherit";

	var messages = ["Hello :)", "Hello :)", "How are you?"];
	var my = false;

	messages.forEach(function(message) {
		drawMessage(message, my);
		my = my ? false: true;
	});

</script>

</body>
</html>